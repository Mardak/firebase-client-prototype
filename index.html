<!DOCTYPE html>
<html>
<head>
  <title>Test page</title>
  <script src="./client.js"></script>
  <style>
p {
  margin: 0;
}
#chat,
#meta,
#output,
#page,
#participant {
  border: 1px solid black;
  max-height: 200px;
  min-height: 1em;
  margin-bottom: 1em;
  overflow: auto;
}

.deleter {
  cursor: pointer;
  margin: 0 5px;
}
  </style>
</head>
<body>
  <p>
    Your participant id:
    <span id="participant-id"></span>
    and name:
    <span id="participant-name"></span>
    <button id="generate-name">generate new name</button>
  </p>
  <div>
    <input id="room-name"/>
    <button id="set-name">set room name</button>
  </div>
  <div>
    <input id="message"/>
    <button id="add-chat">add chat</button>
    <button id="add-page">add page</button>
  </div>
  <br/>

  <div>
    <button id="load-chat">load all chats</button>
  </div>
  Chat messages:
  <div id="chat"></div>
  Pages:
  <div id="page"></div>
  Participants:
  <div id="participant"></div>
  Metas:
  <div id="meta"></div>

  SSE/EventSource output:
  <pre id="output"></pre>

  <script>
let lfs = new LoopFirebaseServer();
lfs.on("update", processRecord);
lfs.on("connect", () => {
  lfs.requestRoomData().then(processRecord);
  let now = lfs.getServerTime();
  lfs.requestChat(now - 24*60*60*1000, now, 5).then(processRecord);

  if (localStorage.pid === undefined) {
    localStorage.pid = lfs.makeId();
  }
  if (localStorage.pname === undefined) {
    localStorage.pname = makeName();
  }
  document.getElementById("participant-id").textContent = localStorage.pid;
  document.getElementById("participant-name").textContent = localStorage.pname;
  lfs.update("participant", localStorage.pid, localStorage.pname);
});

document.getElementById("generate-name").addEventListener("click", () => {
  localStorage.pname = makeName();
  document.getElementById("participant-name").textContent = localStorage.pname;
  lfs.update("participant", localStorage.pid, localStorage.pname);
});

document.getElementById("set-name").addEventListener("click", () => {
  let {value} = document.getElementById("room-name");
  lfs.update("meta", "roomName", value);
});

function handleAdd(event) {
  let type = event.target.id.split("-")[1];
  let {value} = document.getElementById("message");
  lfs.update(type, lfs.makeId(), {
    content: value,
    who: localStorage.pid
  });
}
document.getElementById("add-chat").addEventListener("click", handleAdd);
document.getElementById("add-page").addEventListener("click", handleAdd);

function handleLoadChat() {
  lfs.requestChat().then(records => {
    document.getElementById("chat").textContent = "";
    records.forEach(r => insertEntry(r));
  });
}
document.getElementById("load-chat").addEventListener("click", handleLoadChat);

function insertEntry(record, showId = false) {
  let {id, timestamp, type, value} = record;
  if (type.search(/^(chat|meta|page|participant)$/) === -1) {
    return;
  }

  let deleted = false;
  if (value === undefined) {
    if (type.search(/^(meta|participant)$/) === 0) {
      value = `(empty ${type} record)`;
    }
    else {
      value = `this ${type} was \u274c deleted!`;
      deleted = true;
    }
  }
  else if (type.search(/^(chat|page)$/) === 0) {
    value = `${participants.get(value.who)}: ${value.content}`;
  }

  let time = new Date(timestamp).toLocaleString();
  let content = document.getElementById(id);
  if (!content) {
    content = document.createElement("p");
    content.id = id;
    let parent = document.getElementById(type);
    parent.insertBefore(content, parent.firstChild);
  }
  let idPrefix = showId ? `${id}: ` : "";
  content.textContent = `${idPrefix} ${value} (${time})`;

  while (true) {
    let gotLink = content.lastChild.textContent.match(/^(.*?)(https?:\/\/[^" ]*[^" \.,\?!])(.*)$/);
    if (gotLink === null) {
      break;
    }

    content.lastChild.textContent = gotLink[1];

    let link = document.createElement("a");
    link.href = gotLink[2];
    link.textContent = gotLink[2];
    content.appendChild(link);

    content.appendChild(document.createTextNode(gotLink[3]));
  }

  if (!deleted) {
    let remove = document.createElement("span");
    remove.className = "deleter";
    remove.textContent = "\u274C";
    content.appendChild(remove);
    remove.addEventListener("click", () => {
      lfs.delete(type, id);
    });
  }
}

let participants = new Map();
function processRecord(record) {
  if (Array.isArray(record)) {
    record.forEach(processRecord);
    return;
  }
  switch (record.type) {
    case "chat":
    case "page":
      insertEntry(record);
      break;

    case "participant":
      insertEntry(record, true);
      participants.set(record.id, record.value);
      break;

    case "meta":
      insertEntry(record, true);
      switch (record.id) {
        case "roomName":
          document.getElementById("room-name").value = record.value;
          break;
      }
      break;
  }
}

const adjectives = "accomplished,adept,appreciative,blithe,bouncy,bubbly,caring,cautious,cultured,dependable,desirable,devoted,easygoing,eloquent,exuberant,forgiving,fortunate,friendly,generous,genial,glad,hardworking,hearty,helpful,illustrious,intelligent,inventive,jaunty,jolly,judicious,keen,kind,knowledgeable,learned,lenient,literate,master,merciful,meticulous,natty,nice,nurturing,obedient,objective,observant,patient,perky,proficient,qualified,quality,quirky,rational,reasonable,responsible,sagacious,sane,supportive,tactful,tireless,tolerant,unbiased,understanding,upbeat,vigilant,virtuous,vocal,watchful,wacky,wholesome,xanthous,xenial,xenodochial,yogic,young,youthful,zealous,zesty,zany".split(",");
const nouns = "afador,akita,ausky,barbet,beagle,bowzer,carkie,chichi,collie,daniff,dingo,dogo,elkkee,eskland,ewokian,feist,fochon,frengle,glechon,gollie,greyhound,harrier,hound,husky,ibizan,imoinu,istrian,jachon,jindo,jug,kimola,kuvasz,kyileo,labbe,lhatese,lupo,mauzer,miki,mutt,neapolitan,norfolk,norwich,oldepit,oripei,otterhound,pitsky,plica,puggat,queensland,quinbrindle,quocridge,raggle,reagle,rottle,scoshi,shiba,silkin,taigan,tosa,toxirn,ultimate,ussel,utonagan,vanjari,vikhan,vizsla,wauzer,weston,woodle,xasheeler,xofhound,xoloitz,yoranian,yorkie,yorwich,zawakh,zoibor,zuchon".split(",");
function makeName() {
  let adjIndex = Math.floor(adjectives.length * Math.random());
  let nounIndex = Math.floor(adjIndex / 3) * 3 + Math.floor(Math.random() * 3);
  return `${adjectives[adjIndex]} ${nouns[nounIndex]}`;
}
  </script>
</body>
</html>
